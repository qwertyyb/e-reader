# E-Reader åŒæ­¥æœåŠ¡ Makefile

.PHONY: help install dev build start docker-build docker-build-npm docker-build-x64 docker-build-arm64 docker-build-multiarch docker-run docker-up docker-down docker-logs clean

# é»˜è®¤ç›®æ ‡
help:
	@echo "E-Reader åŒæ­¥æœåŠ¡ - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "å¼€å‘å‘½ä»¤:"
	@echo "  install      - å®‰è£…ä¾èµ–"
	@echo "  dev          - å¼€å‘æ¨¡å¼è¿è¡Œ"
	@echo "  build        - æ„å»ºé¡¹ç›®"
	@echo "  start        - ç”Ÿäº§æ¨¡å¼è¿è¡Œ"
	@echo ""
	@echo "Docker å‘½ä»¤:"
	@echo "  docker-build           - æ„å»º Docker é•œåƒ (å½“å‰å¹³å°)"
	@echo "  docker-build-x64       - æ„å»º x64 æ¶æ„é•œåƒ"
	@echo "  docker-build-arm64     - æ„å»º ARM64 æ¶æ„é•œåƒ"
	@echo "  docker-build-multiarch - æ„å»ºå¤šå¹³å°é•œåƒ"
	@echo "  docker-build-npm       - æ„å»º Docker é•œåƒ (npm ç‰ˆæœ¬)"
	@echo "  docker-run             - è¿è¡Œå•ä¸ªå®¹å™¨"
	@echo "  docker-up              - ä½¿ç”¨ docker-compose å¯åŠ¨"
	@echo "  docker-down            - åœæ­¢ docker-compose æœåŠ¡"
	@echo "  docker-logs            - æŸ¥çœ‹å®¹å™¨æ—¥å¿—"
	@echo ""
	@echo "å…¶ä»–å‘½ä»¤:"
	@echo "  clean        - æ¸…ç†æ„å»ºæ–‡ä»¶"

# å¼€å‘å‘½ä»¤
install:
	pnpm install

dev:
	pnpm run dev

build:
	pnpm run build

start:
	pnpm start

# Docker å‘½ä»¤ (å¤šå¹³å°æ„å»º)
docker-build:
	@echo "ğŸ”¨ æ„å»º Docker é•œåƒ (å½“å‰å¹³å°)..."
	docker-buildx build --target runtime -t e-reader-sync-server:latest --load .
	@echo "âœ… æ„å»ºå®Œæˆ!"

docker-build-x64:
	@echo "ğŸ”¨ æ„å»º x64 æ¶æ„ Docker é•œåƒ..."
	./scripts/build.sh latest Dockerfile linux/amd64
	@echo "âœ… x64 é•œåƒæ„å»ºå®Œæˆ!"

docker-build-arm64:
	@echo "ğŸ”¨ æ„å»º ARM64 æ¶æ„ Docker é•œåƒ..."
	./scripts/build.sh latest Dockerfile linux/arm64
	@echo "âœ… ARM64 é•œåƒæ„å»ºå®Œæˆ!"

docker-build-multiarch:
	@echo "ğŸŒ æ„å»ºå¤šå¹³å° Docker é•œåƒ..."
	./scripts/build-multiarch.sh
	@echo "âœ… å¤šå¹³å°é•œåƒæ„å»ºå®Œæˆ!"

docker-build-npm:
	@echo "ğŸ”¨ æ„å»ºå¤šé˜¶æ®µ Docker é•œåƒ (npm)..."
	docker-buildx build --platform linux/amd64 --target runtime -t e-reader-sync-server:npm -f Dockerfile.npm --load .
	@echo "âœ… æ„å»ºå®Œæˆ!"

docker-run:
	docker run -p 3000:3000 --name e-reader-server e-reader-sync-server:latest

docker-run-x64:
	docker run --platform linux/amd64 -p 3000:3000 --name e-reader-server-x64 e-reader-sync-server:latest

docker-up:
	docker-compose up -d

docker-down:
	docker-compose down

docker-logs:
	docker-compose logs -f

# éƒ¨ç½²å‘½ä»¤
deploy:
	./scripts/deploy.sh

# æµ‹è¯•å‘½ä»¤
test-health:
	@echo "ğŸ” æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹..."
	curl -f http://localhost:3000/health || echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"

# æ¸…ç†å‘½ä»¤
clean:
	rm -rf dist/
	rm -rf node_modules/
	docker-compose down --volumes --remove-orphans || true
	docker rmi e-reader-sync-server:latest || true
	docker rmi e-reader-sync-server:npm || true

# é•œåƒåˆ†æ
docker-analyze:
	@echo "ğŸ“Š åˆ†æ Docker é•œåƒ..."
	docker images | grep e-reader-sync-server
	@echo ""
	@echo "ğŸ” é•œåƒå†å²:"
	docker history e-reader-sync-server:latest

# å¤šå¹³å°ç›¸å…³å‘½ä»¤
docker-setup-buildx:
	@echo "ğŸ”§ è®¾ç½® Docker Buildx..."
	docker-buildx create --name multiarch --use --bootstrap || docker-buildx use multiarch

docker-inspect-multiarch:
	@echo "ğŸ” æ£€æŸ¥å¤šå¹³å°é•œåƒ..."
	docker-buildx imagetools inspect e-reader-sync-server:latest